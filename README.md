# rs-demo

The demos are implemented as Jupyter notebooks.

## Run on local mode

On local mode, docker-compose and Docker images are used to run services and libraries locally (not on a cluster). There is no authentication for this mode.

### Prerequisites

  * You have Docker installed on your system, see: https://docs.docker.com/engine/install/
  * You have access to the RSPY project on GitHub: https://github.com/RS-PYTHON
  * You have created a personal access token (PAT) on GitHub: https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens

    This access token is used to retrieve the rs-server product on the github repository.
    You may want to create a classic PAT with the read:packages permissions.
  * You have checked out this git project and submodules and built docker images:

    ```bash
    git clone git@github.com:RS-PYTHON/rs-demo.git # with SSH
    # or `git clone https://github.com/RS-PYTHON/rs-demo.git` with HTTPS

    # Get last version
    cd rs-demo
    git checkout main

    # Checkout the git stac submodules (can take a few minutes)
    git submodule update --init --recursive
    ```

### Run the demos on local mode

To pull the latest Docker images, run:

```bash
# Login into the project ghcr.io (GitHub Container Registry)
# Username: your GitHub login
# Password: your personnal access token (PAT) created above
docker login https://ghcr.io/v2/rs-python

# From the resources directory, pull the images
cd ./resources
docker compose pull

# Note: we have a warning 'pull access denied for stac-utils/stac-fastapi-pgstac'
# that is normal: we built this image manually in the prerequisites.
```

Then to run the demos:

```bash
# Still from the resources directory, if you're not there yet
cd ./resources

# Run all services.
# Note: in case of port conflicts, you can kill all your running docker containers with:
# docker rm -f $(docker ps -aq)
docker compose down -v; docker compose up # -d for detached

# Note: we always need to call 'down' before 'up' or we'll have errors
# when the stac database will initialize a second time.
```

Near the end of the logs you will see some Jupyter information e.g:
```
jupyter | To access the server, open this file in a browser:
jupyter |     ...
jupyter | Or copy and paste one of these URLs:
jupyter |     ...
jupyter |     http://127.0.0.1:8888/lab?token=612cb124335d9ab80a5a6414631a7df186b2401234050001
```

Open (ctrl-click) the http://127.0.0.1:8888/lab?token=... link to open the Jupyter web client (=Jupyter Notebook) in your browser.

__Note__: the token is auto-generated by Jupyter and changes everytime you relaunch the containers. So after relaunching, your old Jupyter web session won't be available anymore.

On the left, in the file explorer, the demos are under `/rspy-demos`:

![alt text](./doc/images/jupyter.png "Title")

```bash
# When you're done, shutdown all services and volumes (-v)
# with Ctrl-C (if not in detached mode i.e. -d) then:
docker compose down -v

# You can use this to remove all docker volumes 
# (use with care if you have other docker containers)
docker volume prune
```

## How does it work

The [docker-compose.yml](resources/docker-compose.yml) file uses Docker images to run all the necessary container services for the demos :

  * The latest rs-server images available:
    * Built from the CI/CD: https://github.com/RS-PYTHON/rs-server/actions/workflows/publish-binaries.yml
    * Available in the ghcr.io: https://github.com/orgs/RS-PYTHON/packages
  * The ADGS, CADIP ... station mockups:
    * Built from the CI/CD: https://github.com/RS-PYTHON/rs-testmeans/actions/workflows/publish-docker.yml
    * Also available in the ghcr.io
  * STAC PostgreSQL database
  * MinIO S3 bucket server
  * Jupyter server

These containers are run locally (not on a cluster). The Jupyter notebooks accessed from http://127.0.0.1:8888 are run from the containerized Jupyter server, not from your local environment. This Jupyter environment contains all the Python modules required to call the rs-server HTTP endpoints.

## [TIP] to run your local rs-server code in this environment

It can be helpful to use your last rs-server code version to debug it or to test modifications without pushing them and rebuilding the Docker image. To do this:

1. Go to the [./resources](resources) directory and run: `cp 'docker-compose.yml' 'docker-compose-debug.yml'`

1. If your local `rs-server` github repository is under `/my/local/rs-server`, modify the `docker-compose-debug.yml` file to mount your local `rs-server` services:

    ```yaml
    # e.g.
    rs-server-adgs:
      # ...
      volumes:
        - /my/local/rs-server/services/common/rs_server_common:/usr/local/lib/python3.11/site-packages/rs_server_common
        - /my/local/rs-server/services/adgs/rs_server_adgs:/usr/local/lib/python3.11/site-packages/rs_server_adgs
        - /my/local/rs-server/services/adgs/config:/usr/local/lib/python3.11/site-packages/config
        # - and any other useful files ...
    ```

1. Run the demo with:

    ```bash
    # Still from the resources directory, if you're not there yet
    cd ./resources

    # Run all services
    docker compose down -v; \
      docker compose \
        -f docker-compose-debug.yml \
        -f ./stac/stac-fastapi-pgstac/docker-compose.yml \
        up # -d for detached
    ```

## Run on cluster mode

On cluster mode, we run the Jupyter notebooks locally, but they connect to the services deployed on the rs-server website (=cluster). Authentication is required for this mode.

### Prerequisites

  * You have access to the rs-server website: https://dev-rspy.esa-copernicus.eu
  * You have saved the S3 bucket configuration in you local file: `~/.s3cfg`
  * You have python installed on your system
  * You have installed Jupyter Lab (`pip install jupyterlab`)
  * You have installed the rs-client project with either:

    * `pip install rs_client_libraries-*.whl` (to install a static release) or
    * `pip install -e /path/to/local/project/rs-client-libraries` (to install dynamically from the source code, if you have access to it)

  * You have generated an API key from https://dev-rspy.esa-copernicus.eu/docs

### Run the demos on cluster mode

From your terminal in the rs-demo, run:

```bash
cd ./scripts
export RSPY_APIKEY=your_api_key # see the prerequisites
./start-jupyterlab-for-cluster-mode.sh
```

The Jupyter web client (=Jupyter Notebook) opens in a new tab of your browser. 