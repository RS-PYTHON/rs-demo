name: Run all demos

on:
  push:
  workflow_dispatch:

    # TODO ? versions as parameters
    # https://damienaicheh.github.io/github/actions/2022/01/20/set-dynamic-parameters-github-workflows-en.html

env:
  DOCKER_REGISTRY: ghcr.io

jobs:

  test:
    runs-on: ubuntu-latest
    name: Run all demos
    steps:
      - uses: actions/checkout@v4
        with: 
          submodules: true

      - name: Log into Docker registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Init environment and run all demos
        run: |
          set -x

          # From the resources directory, pull the images
          cd ${GITHUB_WORKSPACE}/resources
          docker compose pull || true # ignore stac warnings about the docker images we will build with 'docker compose up'

          # Run all services
          docker compose down; docker compose up -d
          docker compose ls

          # Run all demos
          ${GITHUB_WORKSPACE}/scripts/run-notebooks.sh
          
          # Shutdown docker services and volumes
          docker compose down -v

        shell: bash